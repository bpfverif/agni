name: End-to-End Tests
on:
  # Run once a day, every day.
  schedule:
    - cron:  '0 0 * * *'
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  end-to-end:
    strategy:
      fail-fast: false
      matrix:
        kernel: ["5.19", "6.0"]
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            clang-14 llvm-14 llvm-14-tools llvm \
            python3 python3-pip \
            make cmake libelf-dev \
            libjsoncpp-dev stress-ng \
            libz3-dev

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          cd bpf-verification
          pip install .

      - name: Retrieve Linux sources
        run: |
          set -o xtrace

          tree=git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
          depth="--depth 1"
          if [ "${{ matrix.kernel }}" == "6.8" ] || [ "${{ matrix.kernel }}" == "6.9" ]; then
            depth=""
          fi
          git clone $depth -q -b v${{ matrix.kernel }} $tree linux
          if [ "${{ matrix.kernel }}" == "6.8" ] || [ "${{ matrix.kernel }}" == "6.9" ]; then
            cd linux
            git config --global user.email "no-reply@example.com"
            git config --global user.name "Agni Authors"
            git cherry-pick 4c2a26fc80bcb851dc630
          fi

      - name: Generate encodings
        id: generate-encodings
        run: |
          set -o xtrace

          cd "${{ github.workspace }}/linux"
          commit=$(git rev-parse HEAD)
          cd -

          mkdir -p bpf-encodings/${{ matrix.kernel }}
          cd llvm-to-smt

          python3 generate_encodings.py \
            --kernver ${{ matrix.kernel }} --commit $commit \
            --kernbasedir "${{ github.workspace }}/linux" \
            --outdir ../bpf-encodings/${{ matrix.kernel }} \
            --modular

      - name: Upload encodings
        if: ${{ always() }} && steps.generate-encodings.outcome != 'skipped'
        uses: actions/upload-artifact@master
        with:
          name: bpf-encodings-${{ matrix.kernel }}
          path: bpf-encodings/${{ matrix.kernel }}/

      - name: Verify on v${{ matrix.kernel }}
        id: bpf-verification
        run: |
          mkdir results-${{ matrix.kernel }}
          cd bpf-verification
          python3 src/bpf_alu_jmp_synthesis.py --kernver ${{ matrix.kernel }} --encodings_path ../bpf-encodings/${{ matrix.kernel }} --res_path ../results-${{ matrix.kernel }}

